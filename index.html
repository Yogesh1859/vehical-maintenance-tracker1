<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vehicle Maintenance Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      min-height: 100vh;
      background: #f4f6f8;
      color: #222;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }
    header {
      background: #0077b6;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .sidebar {
      width: 220px;
      background: #023e8a;
      color: white;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      margin-bottom: 1rem;
    }
    .sidebar button {
      background: transparent;
      border: none;
      color: white;
      padding: 0.8rem;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
    }
    .sidebar button:hover {
      background: #0077b6;
    }
    main {
      flex: 1;
      padding: 1rem;
      max-width: 1000px;
      margin: auto;
    }
    h2 { color: #0077b6; }
    .card {
      background: white;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: background 0.3s, color 0.3s;
    }
    body.dark .card {
      background: #1e1e1e;
      color: #eee;
    }
    label { display: block; margin-top: 0.5rem; }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button.action {
      background: #0077b6;
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    button.action:hover { background: #005f86; }
    ul { list-style: none; padding: 0; }
    li {
      padding: 0.6rem;
      margin: 0.5rem 0;
      border-left: 6px solid #0077b6;
      border-radius: 4px;
      background: #fdfdfd;
    }
    .due-soon { border-color: orange; }
    .overdue { border-color: red; }
    .on-time { border-color: green; }
    .hidden { display: none; }
    #logoutBtn {
      background: #ff4d4d;
      border: none;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #logoutBtn:hover { background: #cc0000; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toggle-dark {
      background: #0077b6;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    canvas { max-width: 100%; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>ðŸš— VMT</h2>
    <button id="navDashboard">Dashboard</button>
    <button id="navVehicles">Vehicles</button>
    <button id="navServices">Services</button>
    <button id="navProfile">Profile</button>
    <button id="logoutBtn" class="hidden">Logout</button>
    <button class="toggle-dark">ðŸŒ™ Toggle Dark</button>
  </div>

  <main>
    <!-- Register -->
    <section id="registerSection" class="card">
      <h2>Register</h2>
      <form id="registerForm">
        <label>Email: <input type="email" id="regUser" required></label>
        <label>Password: <input type="password" id="regPass" required></label>
        <button type="submit" class="action">Register</button>
      </form>
      <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
    </section>

    <!-- Login -->
    <section id="loginSection" class="card hidden">
      <h2>Login</h2>
      <form id="loginForm">
        <label>Email: <input type="email" id="loginUser" required></label>
        <label>Password: <input type="password" id="loginPass" required></label>
        <button type="submit" class="action">Login</button>
      </form>
      <p>No account? <a href="#" id="showRegister">Register here</a></p>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="hidden">
      <div class="top-bar">
        <h2>Welcome, <span id="currentUser"></span> ðŸ‘‹</h2>
      </div>

      <!-- Vehicles -->
      <div class="card">
        <h3>Add Vehicle</h3>
        <form id="vehicleForm">
          <label>Vehicle Name: <input type="text" id="vehicleName" required></label>
          <label>Model/Year: <input type="text" id="vehicleModel" required></label>
          <label>Registration No: <input type="text" id="vehicleReg" required></label>
          <button type="submit" class="action">Add Vehicle</button>
        </form>
      </div>
      <div class="card">
        <h3>Vehicles</h3>
        <ul id="vehicleList"></ul>
      </div>

      <!-- Services -->
      <div class="card">
        <h3>Add Service</h3>
        <form id="serviceForm">
          <label>Select Vehicle:
            <select id="serviceVehicle" required></select>
          </label>
          <label>Service Type:
            <select id="serviceType" required>
              <option value="wash">Regular Wash (1 Month)</option>
              <option value="oil">Oil Change (3 Months)</option>
              <option value="regular">Regular Service (6 Months)</option>
            </select>
          </label>
          <label>Service Date: <input type="date" id="serviceDate" required></label>
          <button type="submit" class="action">Add Service</button>
        </form>
      </div>
      <div class="card">
        <h3>Service Logs</h3>
        <input type="text" id="searchService" placeholder="Search by vehicle ID or type...">
        <select id="filterService">
          <option value="all">All</option>
          <option value="due">Due Soon</option>
          <option value="overdue">Overdue</option>
        </select>
        <ul id="serviceList"></ul>
      </div>

      <!-- Reports -->
      <div class="card">
        <h3>Service Report</h3>
        <canvas id="serviceChart"></canvas>
      </div>

      <!-- Profile -->
      <div class="card" id="profileSection">
        <h3>Profile</h3>
        <p>Email: <span id="profileEmail"></span></p>
        <button id="resetPass" class="action">Reset Password</button>
      </div>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbuZk615mBhD9GJ2DpQ8Hr1rI0ZKQTSao",
      authDomain: "vehical-mainatence-1.firebaseapp.com",
      projectId: "vehical-mainatence-1",
      storageBucket: "vehical-mainatence-1.firebasestorage.app",
      messagingSenderId: "426113189366",
      appId: "1:426113189366:web:b3d1a12a318d827a7733d7",
      measurementId: "G-76GBZYHZ0Z"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elements
    const registerSection = document.getElementById("registerSection");
    const loginSection = document.getElementById("loginSection");
    const dashboard = document.getElementById("dashboard");
    const regForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const showLogin = document.getElementById("showLogin");
    const showRegister = document.getElementById("showRegister");
    const currentUserEl = document.getElementById("currentUser");
    const profileEmail = document.getElementById("profileEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const vehicleForm = document.getElementById("vehicleForm");
    const serviceForm = document.getElementById("serviceForm");
    const vehicleList = document.getElementById("vehicleList");
    const serviceList = document.getElementById("serviceList");
    const serviceVehicle = document.getElementById("serviceVehicle");
    const searchService = document.getElementById("searchService");
    const filterService = document.getElementById("filterService");
    const resetPassBtn = document.getElementById("resetPass");
    const toggleDark = document.querySelector(".toggle-dark");

    // Navigation buttons
    document.getElementById("navDashboard").onclick = () => showSection("dashboard");
    document.getElementById("navVehicles").onclick = () => window.scrollTo(0, 300);
    document.getElementById("navServices").onclick = () => window.scrollTo(0, 800);
    document.getElementById("navProfile").onclick = () => document.getElementById("profileSection").scrollIntoView({behavior:"smooth"});

    // Dark mode toggle
    toggleDark.onclick = () => document.body.classList.toggle("dark");

    // Show/hide forms
    showLogin.addEventListener("click", () => {
      registerSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
    });
    showRegister.addEventListener("click", () => {
      loginSection.classList.add("hidden");
      registerSection.classList.remove("hidden");
    });

    // Register
    regForm.addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("regUser").value;
      const pass = document.getElementById("regPass").value;
      auth.createUserWithEmailAndPassword(email, pass)
        .then(() => alert("Registered successfully! Please login."))
        .catch(err => alert(err.message));
      regForm.reset();
    });

    // Login
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("loginUser").value;
      const pass = document.getElementById("loginPass").value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert(err.message));
    });

    // Auth state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        startDashboard(user);
      } else {
        dashboard.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    });

    // Dashboard
    function startDashboard(user) {
      registerSection.classList.add("hidden");
      loginSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      currentUserEl.textContent = user.email;
      profileEmail.textContent = user.email;
      loadVehicles(user);
      loadServices(user);
    }

    // Logout
    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });

    // Reset password
    resetPassBtn.addEventListener("click", () => {
      const user = auth.currentUser;
      if (user) {
        auth.sendPasswordResetEmail(user.email).then(() => {
          alert("Password reset email sent!");
        }).catch(err => alert(err.message));
      }
    });

    // Vehicle Form
    vehicleForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("vehicleName").value;
      const model = document.getElementById("vehicleModel").value;
      const regNo = document.getElementById("vehicleReg").value;
      const user = auth.currentUser;
      if (!user) return;

      try {
        await db.collection("users").doc(user.uid).collection("vehicles").add({
          name, model, regNo, createdAt: new Date()
        });
        vehicleForm.reset();
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Service Form
    serviceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const vehicleId = serviceVehicle.value;
      const type = document.getElementById("serviceType").value;
      const date = document.getElementById("serviceDate").value;
      const user = auth.currentUser;
      if (!user) return;

      try {
        await db.collection("users").doc(user.uid).collection("services").add({
          vehicleId, type, date, createdAt: new Date()
        });
        serviceForm.reset();
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Load Vehicles (real-time)
    function loadVehicles(user) {
      vehicleList.innerHTML = "";
      serviceVehicle.innerHTML = "";
      db.collection("users").doc(user.uid).collection("vehicles")
        .orderBy("createdAt")
        .onSnapshot(snapshot => {
          vehicleList.innerHTML = "";
          serviceVehicle.innerHTML = "";
          snapshot.forEach(doc => {
            const v = doc.data();
            const li = document.createElement("li");
            li.textContent = `${v.name} (${v.model}) - ${v.regNo}`;
            vehicleList.appendChild(li);

            const opt = document.createElement("option");
            opt.value = doc.id;
            opt.textContent = v.name;
            serviceVehicle.appendChild(opt);
          });
        });
    }

    // Load Services (real-time with status + filters)
    function loadServices(user) {
      db.collection("users").doc(user.uid).collection("services")
        .orderBy("createdAt")
        .onSnapshot(snapshot => {
          renderServices(snapshot.docs.map(doc => ({id:doc.id, ...doc.data()})));
        });
    }

    function renderServices(services) {
      serviceList.innerHTML = "";
      const searchVal = searchService.value.toLowerCase();
      const filterVal = filterService.value;

      let counts = { wash:0, oil:0, regular:0 };

      services.forEach(s => {
        // Filter/search
        if (searchVal && !(`${s.vehicleId} ${s.type}`.toLowerCase().includes(searchVal))) return;

        // Status check
        const now = new Date();
        const serviceDate = new Date(s.date);
        let nextDue = new Date(serviceDate);
        if (s.type==="wash") nextDue.setMonth(nextDue.getMonth()+1);
        if (s.type==="oil") nextDue.setMonth(nextDue.getMonth()+3);
        if (s.type==="regular") nextDue.setMonth(nextDue.getMonth()+6);

        let statusClass = "on-time";
        if ((nextDue - now) < 0) statusClass = "overdue";
        else if ((nextDue - now) < (7*24*60*60*1000)) statusClass = "due-soon";

        if (filterVal==="due" && statusClass!=="due-soon") return;
        if (filterVal==="overdue" && statusClass!=="overdue") return;

        counts[s.type]++;

        const li = document.createElement("li");
        li.className = statusClass;
        li.textContent = `${s.type} for vehicle [${s.vehicleId}] on ${s.date} (Next: ${nextDue.toDateString()})`;
        serviceList.appendChild(li);
      });

      // Update chart
      updateChart(counts);
    }

    // Search/filter listeners
    searchService.oninput = () => auth.currentUser && loadServices(auth.currentUser);
    filterService.onchange = () => auth.currentUser && loadServices(auth.currentUser);

    // Chart
    let chart;
    function updateChart(counts) {
      const ctx = document.getElementById("serviceChart");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Wash", "Oil Change", "Regular Service"],
          datasets: [{
            data: [counts.wash, counts.oil, counts.regular],
            backgroundColor: ["#00b4d8","#90be6d","#f9844a"]
          }]
        }
      });
    }

    function showSection(sectionId) {
      document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
      document.getElementById(sectionId).classList.remove("hidden");
    }
  </script>
</body>
</html>
